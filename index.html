<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>K65 ETA</title>
  <link rel="manifest" href="manifest.json" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">


  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-router/6.21.0/react-router.production.min.js"
    integrity="sha512-lC1wfkttgEpBOZxbHADBEscmWP7x9CLBpVt5STN/JCWyRyNFgjLB4qBJKKMNpDsQK3p8sDYejbqn23F0ick0rQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-bootstrap@next/dist/react-bootstrap.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-redux@8.0.5/dist/react-redux.min.js"></script>
  <script src="https://unpkg.com/@reduxjs/toolkit@1.9.7/dist/redux-toolkit.umd.js"></script>
</head>

<body>
  <main>
    <div id="root"></div>
  </main>

  <script src="js/app.js"></script>
  <script type="text/babel">
    const { useEffect, useState, useContext, createContext } = React
    const { Stack } = ReactBootstrap
    const { useDispatch, useSelector, Provider } = ReactRedux;
    const { configureStore, createSlice } = RTK

    const etaSlice = createSlice({
      name: 'eta',
      initialState: {
        routes: [],
        etas: [],
      },
      reducers: {
        addRoutes: (state, action) => {
          state.routes.push(...action.payload);
        },
        removeRoutes: (state, action) => {
          action.forEach(route => {
            const index = state.routes.findIndex(route => route.id === action.payload)
            if (index !== -1) {
              state.routes = [
                ...state.routes.slice(0, index),
                ...state.routes.slice(index + 1)
              ]
            }
          })
        },
      }
    })

    const { addRoutes, removeRoutes } = etaSlice.actions

    const store = configureStore({
      reducer: etaSlice.reducer
    })

    const useEtaUpdater = (interval = 5000) => {
      const dispatch = useDispatch()
      const routes = useSelector(state => state.routes)

      const fetchETA = async (route) => {
        let respond = await fetch('https://rt.data.gov.hk/v1/transport/mtr/bus/getSchedule', {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            "language": "zh",
            "routeName": route + ""
          })
        })

        return await respond.json();
      }

      const fetchETAs = async (routes) => await Promise.all(routes.map(route => fetchETA(route)))

      useEffect(() => {
        let intervalId;

        const fetchETAForRoutes = async () => {
          try {
            const etaData = await fetchETAs(routes)
            // Update the ETA data in the Redux store
            dispatch(updateETA(etaData));
          } catch (error) {
            console.error('Error fetching ETA:', error);
          }
        }

        const startFetchingETA = () => {
          fetchETAForRoutes()

          intervalId = setInterval(() => {
            fetchETAForRoutes()
          }, interval)
        }

        const stopFetchingETA = () => {
          clearInterval(intervalId);
        }

        if (routes.length > 0) {
          startFetchingETA()
        } else {
          stopFetchingETA()
        }

        return () => {
          stopFetchingETA()
        }
      }, [dispatch, routes, interval])

      return null
    };

    const init = [
      {
        id: 'D020',
        title: '新慶村',
        data: [
          {
            route: 'K65',
            stop: 'K65-D020'
          },
          {
            route: 'K65A',
            stop: 'K65A-D020'
          },
        ]
      },
      {

        id: 'D020',
        title: '新慶村',
        data: [
          {
            route: 'K65',
            stop: 'K65-D020'
          },
          {
            route: 'K65A',
            stop: 'K65A-D020'
          },
        ]
      },
    ]

    function Root() {
      return (
        <Provider store={store}>
          <Home />
        </Provider>
      )
    }

    function Home() {
      const SavedGroupsContext = createContext(init)
      useEtaUpdater()

      return (
        <SavedGroup group={init[0]} />
      )
    }

    function Greetings() {
      return <h1>Hello readers, Thankyou for reading this blog !</h1>;
    }

    function SavedGroup({ group }) {
      const dispatch = useDispatch()

      // Dispatch the addRoute action whenthe SavedGroup component is rendered
      useEffect(() => {
        // Assuming the group object has a route ID
        dispatch(addRoutes(group.data.map(d => d.route)))

        return () => {
          // Dispatch the removeRoute action when the SavedGroup component is unmounted
          dispatch(removeRoutes(group.routeId))
        };
      }, [dispatch, group.routeId]);

      return (
        <Stack gap={3}>
          <h2>{group.title}</h2>
        </Stack>
      )
    }

    ReactDOM.render(
      (
        <Root />
      ),
      document.getElementById("root")
    );
  </script>

  <script>
    console.log(ReactRouterDOM);
    new Vue({
      el: '#app',
      data: {
        routes: ['K65', 'K65A'],
        directions: [
          outbound = {
            name: '往天水圍/元朗',
            stops: [
              {
                id: 'D020',
                stopName: '新慶村',
                stopIds: [
                  'K65-D020',
                  'K65A-D020'
                ],
                eta: []
              },
            ]
          },
          inbound = {
            name: '往流浮山',
            stops: [
              {
                id: 'U110',
                stopName: '輕鐵坑尾村站',
                stopIds: [
                  'K65-U110'
                ],
                eta: []
              },
              {
                id: 'U010',
                stopName: '天水圍站 (輕鐵天水圍站)',
                stopIds: [
                  'K65A-U010'
                ],
                eta: []
              },
              {
                id: 'U120',
                stopName: '天盛苑 (港鐵天水圍站)',
                stopIds: [
                  'K65-U120',
                  'K65A-U020'
                ],
                eta: []
              },
            ]
          }
        ],
      },
      computed: {
      },
      beforeMount() {
        console.log("beforeMount");
        console.log(this.routes);
        this.fetchData();
        setInterval(() => {
          this.fetchData();
        }, 5000);
      },
      methods: {
        async fetchData() {
          this.routes.forEach(async (route) => {
            const routeData = await this.fetchLineEta(route);
            this.directions.forEach((bound) => {
              bound.stops.forEach((stop) => {
                stop.stopIds.forEach((stopId) => {
                  const stopData = routeData.busStop.filter((stopData) => stopData.busStopId == stopId);
                  if (stopData.length == 0) return;

                  if (stop.eta)
                    stop.eta = stop.eta.filter((eta) => eta.route != route);


                  // build eta
                  const eta = stopData[0].bus.map((bus) => {
                    var time = new Date();
                    const secRemainder = (time.getSeconds() + 6) % 15

                    const currentSec = secRemainder == 0 ? time.getSeconds() : (time.getSeconds() - secRemainder);
                    time.setSeconds(currentSec + parseInt(bus.arrivalTimeText ? bus.arrivalTimeInSecond : bus.departureTimeInSecond));

                    return {
                      route: routeData.routeName,
                      busId: bus.busId,
                      etaText: bus.arrivalTimeText ? bus.arrivalTimeText : bus.departureTimeText,
                      detailTime: time,
                      busRemark: this.buildRemarkStr(bus)
                    }
                  });

                  // add and sort eta
                  stop.eta = [...stop.eta, ...eta];
                  stop.eta.sort((a, b) => {
                    return a.detailTime - b.detailTime;
                  });
                });
              });
            });
          });
        },
        async fetchLineEta(line) {
          let respond = await fetch('https://rt.data.gov.hk/v1/transport/mtr/bus/getSchedule', {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              "language": "zh",
              "routeName": line
            })
          });

          return await respond.json();
        },
        buildRemarkStr(bus) {
          const remarkList = [
            bus.isScheduled == 1 ? "預定班次" : "",
            bus.isDelayed == 1 ? "稍為延誤" : "",
            bus.busRemark ?? ""
          ];

          const remark = remarkList.filter((remark) => remark != "");

          return remark.join(' / ');
        }
      }
    });
  </script>


</body>

</html>